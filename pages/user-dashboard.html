<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard - WellnessHub</title>
  <link rel="stylesheet" href="../style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <div class="header-container">
      <div class="logo">WellnessHub</div>
      <nav>
        <ul>
          <li><a href="#" onclick="loadSection('dashboard')">Dashboard</a></li>
          <li><a href="#" onclick="loadSection('workouts')">Workouts</a></li>
          <li><a href="#" onclick="loadSection('nutrition')">Nutrition</a></li>
          <li><a href="#" onclick="loadSection('progress')">Progress</a></li>
          <li><a href="#" onclick="loadSection('community')">Community</a></li>
        </ul>
      </nav>
      <div class="nav-buttons">
        <button id="profile-btn" class="btn btn-outline btn-small" onclick="loadSection('profile')">Profile</button>
        <button class="btn btn-outline btn-small" onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <h3 style="margin-bottom: 1.5rem; color: #1f2937;">Menu</h3>
      <ul class="sidebar-menu">
        <li><a href="#" onclick="loadSection('dashboard')" class="active">üè† Dashboard</a></li>
        <li><a href="#" onclick="loadSection('workouts')">üèãÔ∏è Workouts</a></li>
        <li><a href="#" onclick="loadSection('nutrition')">üçé Nutrition</a></li>
        <li><a href="#" onclick="loadSection('progress')">üìà Progress</a></li>
        <li><a href="#" onclick="loadSection('community')">üë• Community</a></li>
        <li><a href="#" onclick="loadSection('trainers')">üéì Find Trainers</a></li>
        <li><a href="#" onclick="loadSection('subscription')">üí≥ Subscription</a></li>
        <li><a href="#" onclick="loadSection('profile')">‚öôÔ∏è Profile</a></li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard Section -->
      <section id="dashboard-section" class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
          <h1 style="font-size: 2rem; color: #1f2937;">Dashboard</h1>
          <span id="greeting" style="color: #6b7280;"></span>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Workouts This Week</div>
            <div class="stat-value" id="workout-count">0</div>
          </div>
          <div class="stat-card secondary">
            <div class="stat-label">Meals Logged</div>
            <div class="stat-value" id="meal-count">0</div>
          </div>
          <div class="stat-card accent">
            <div class="stat-label">Current Weight</div>
            <div class="stat-value" id="current-weight">-- kg</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Subscription Status</div>
            <div class="stat-value" id="sub-status" style="font-size: 1rem;">Free</div>
          </div>
        </div>

        <!-- Charts -->
        <div class="grid-2" style="margin-top: 2rem;">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Weekly Workouts</div>
            </div>
            <div style="position: relative; height: 300px;">
              <canvas id="workout-chart"></canvas>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Weight Trend</div>
            </div>
            <div style="position: relative; height: 300px;">
              <canvas id="weight-chart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Workouts Section -->
      <section id="workouts-section" class="section hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
          <h1 style="font-size: 2rem; color: #1f2937;">Workouts</h1>
          <button class="btn btn-secondary" onclick="openModal('workout-modal')">+ Log Workout</button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Recent Workouts</div>
          </div>
          <div class="table-responsive" style="margin-top: 1rem;">
            <table>
              <thead>
                <tr>
                  <th>Exercise</th>
                  <th>Muscle Group</th>
                  <th>Sets x Reps</th>
                  <th>Weight</th>
                  <th>Duration</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="workouts-table">
                <tr>
                  <td colspan="7" style="text-align: center; padding: 2rem; color: #6b7280;">No workouts logged yet</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Nutrition Section -->
      <section id="nutrition-section" class="section hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
          <h1 style="font-size: 2rem; color: #1f2937;">Nutrition</h1>
          <button class="btn btn-secondary" onclick="openModal('meal-modal')">+ Log Meal</button>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Meal Plans</div>
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="openModal('plan-modal')">Create Meal Plan</button>
            <div id="meal-plans" style="margin-top: 1rem;"></div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Today's Intake</div>
            </div>
            <div style="margin-top: 1rem;">
              <div style="display: grid; gap: 1rem;">
                <div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="font-weight: 600;">Calories</span>
                    <span id="daily-calories">0/2000</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" id="cal-progress" style="width: 0%"></div>
                  </div>
                </div>
                <div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="font-weight: 600;">Protein</span>
                    <span id="daily-protein">0g</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" id="protein-progress" style="width: 0%"></div>
                  </div>
                </div>
              </div>
              <button class="btn btn-secondary" style="width: 100%; margin-top: 1.5rem;" onclick="viewDailyMeals()">View Today's Meals</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Progress Section -->
      <section id="progress-section" class="section hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
          <h1 style="font-size: 2rem; color: #1f2937;">Progress Tracking</h1>
          <button class="btn btn-secondary" onclick="openModal('progress-modal')">+ Record Progress</button>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Body Measurements</div>
            </div>
            <div style="margin-top: 1rem;">
              <div id="measurements" style="display: grid; gap: 1rem;"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Weight Progress</div>
            </div>
            <div style="position: relative; height: 300px; margin-top: 1rem;">
              <canvas id="weight-progress-chart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Community Section -->
      <section id="community-section" class="section hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
          <h1 style="font-size: 2rem; color: #1f2937;">Community</h1>
          <button class="btn btn-secondary" onclick="openModal('post-modal')">+ Create Post</button>
        </div>

        <div id="community-feed" style="display: grid; gap: 1.5rem;"></div>
      </section>

      <!-- Find Trainers Section -->
      <section id="trainers-section" class="section hidden">
        <h1 style="font-size: 2rem; color: #1f2937; margin-bottom: 2rem;">Find a Trainer</h1>
        <div id="trainers-list" class="grid-3"></div>
      </section>

      <!-- Subscription Section -->
      <section id="subscription-section" class="section hidden">
        <h1 style="font-size: 2rem; color: #1f2937; margin-bottom: 2rem;">Subscription Management</h1>
        <div id="subscription-info" class="card"></div>
      </section>

      <!-- Profile Section -->
      <section id="profile-section" class="section hidden">
        <h1 style="font-size: 2rem; color: #1f2937; margin-bottom: 2rem;">My Profile</h1>
        <div class="card">
          <div style="max-width: 600px;">
            <form id="profile-form" style="display: grid; gap: 1.5rem;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <div class="form-group">
                  <label for="profile-firstName">First Name</label>
                  <input type="text" id="profile-firstName" required>
                </div>
                <div class="form-group">
                  <label for="profile-lastName">Last Name</label>
                  <input type="text" id="profile-lastName" required>
                </div>
              </div>
              <div class="form-group">
                <label for="profile-bio">Bio</label>
                <textarea id="profile-bio" placeholder="Tell us about your fitness goals..."></textarea>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <div class="form-group">
                  <label for="profile-age">Age</label>
                  <input type="number" id="profile-age">
                </div>
                <div class="form-group">
                  <label for="profile-gender">Gender</label>
                  <select id="profile-gender">
                    <option value="">Select...</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                  </select>
                </div>
              </div>
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modals -->
  <!-- Workout Modal -->
  <div id="workout-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="margin: 0;">Log Workout</h2>
        <button type="button" class="modal-close" onclick="closeModal('workout-modal')">‚úï</button>
      </div>
      <form id="workout-form" style="display: grid; gap: 1.5rem;">
        <div class="form-group">
          <label for="exercise-name">Exercise Name</label>
          <input type="text" id="exercise-name" required placeholder="e.g., Bench Press">
        </div>
        <div class="form-group">
          <label for="muscle-group">Muscle Group</label>
          <select id="muscle-group" required>
            <option value="">Select...</option>
            <option value="Chest">Chest</option>
            <option value="Back">Back</option>
            <option value="Legs">Legs</option>
            <option value="Arms">Arms</option>
            <option value="Shoulders">Shoulders</option>
            <option value="Core">Core</option>
            <option value="Cardio">Cardio</option>
          </select>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
          <div class="form-group">
            <label for="workout-sets">Sets</label>
            <input type="number" id="workout-sets" placeholder="3">
          </div>
          <div class="form-group">
            <label for="workout-reps">Reps</label>
            <input type="number" id="workout-reps" placeholder="10">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
          <div class="form-group">
            <label for="workout-weight">Weight (lbs)</label>
            <input type="number" id="workout-weight" step="0.5" placeholder="185">
          </div>
          <div class="form-group">
            <label for="workout-duration">Duration (min)</label>
            <input type="number" id="workout-duration" placeholder="30">
          </div>
        </div>
        <div class="form-group">
          <label for="workout-notes">Notes</label>
          <textarea id="workout-notes" placeholder="How did the workout feel?"></textarea>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <button type="button" class="btn btn-outline" onclick="closeModal('workout-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Log Workout</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Meal Modal -->
  <div id="meal-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="margin: 0;">Log Meal</h2>
        <button type="button" class="modal-close" onclick="closeModal('meal-modal')">‚úï</button>
      </div>
      <form id="meal-form" style="display: grid; gap: 1.5rem;">
        <div class="form-group">
          <label for="meal-type">Meal Type</label>
          <select id="meal-type" required>
            <option value="breakfast">Breakfast</option>
            <option value="lunch">Lunch</option>
            <option value="dinner">Dinner</option>
            <option value="snack">Snack</option>
          </select>
        </div>
        <div class="form-group">
          <label for="food-name">Food/Meal</label>
          <input type="text" id="food-name" required placeholder="e.g., Grilled Chicken Breast">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
          <div class="form-group">
            <label for="food-quantity">Quantity</label>
            <input type="number" id="food-quantity" step="0.1" placeholder="100">
          </div>
          <div class="form-group">
            <label for="food-unit">Unit</label>
            <select id="food-unit">
              <option value="g">Grams (g)</option>
              <option value="oz">Ounces (oz)</option>
              <option value="cup">Cup</option>
              <option value="piece">Piece</option>
            </select>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
          <div class="form-group">
            <label for="food-calories">Calories</label>
            <input type="number" id="food-calories" placeholder="200">
          </div>
          <div class="form-group">
            <label for="food-protein">Protein (g)</label>
            <input type="number" id="food-protein" step="0.1" placeholder="25">
          </div>
        </div>
        <div style="display: grid; template-columns: 1fr 1fr; gap: 1.5rem;">
          <div class="form-group">
            <label for="food-carbs">Carbs (g)</label>
            <input type="number" id="food-carbs" step="0.1" placeholder="20">
          </div>
          <div class="form-group">
            <label for="food-fat">Fat (g)</label>
            <input type="number" id="food-fat" step="0.1" placeholder="8">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <button type="button" class="btn btn-outline" onclick="closeModal('meal-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Log Meal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Progress Modal -->
  <div id="progress-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="margin: 0;">Record Progress</h2>
        <button type="button" class="modal-close" onclick="closeModal('progress-modal')">‚úï</button>
      </div>
      <form id="progress-form" style="display: grid; gap: 1.5rem;">
        <div class="form-group">
          <label for="progress-weight">Weight (lbs)</label>
          <input type="number" id="progress-weight" step="0.1" placeholder="185">
        </div>
        <div class="form-group">
          <label for="progress-bodyfat">Body Fat %</label>
          <input type="number" id="progress-bodyfat" step="0.1" placeholder="20">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
          <div class="form-group">
            <label for="progress-chest">Chest (in)</label>
            <input type="number" id="progress-chest" step="0.1" placeholder="40">
          </div>
          <div class="form-group">
            <label for="progress-waist">Waist (in)</label>
            <input type="number" id="progress-waist" step="0.1" placeholder="32">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
          <div class="form-group">
            <label for="progress-hips">Hips (in)</label>
            <input type="number" id="progress-hips" step="0.1" placeholder="38">
          </div>
          <div class="form-group">
            <label for="progress-arms">Arms (in)</label>
            <input type="number" id="progress-arms" step="0.1" placeholder="14">
          </div>
        </div>
        <div class="form-group">
          <label for="progress-thighs">Thighs (in)</label>
          <input type="number" id="progress-thighs" step="0.1" placeholder="24">
        </div>
        <div class="form-group">
          <label for="progress-notes">Notes</label>
          <textarea id="progress-notes" placeholder="How are you feeling?"></textarea>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <button type="button" class="btn btn-outline" onclick="closeModal('progress-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Record Progress</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Meal Plan Modal -->
  <div id="plan-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="margin: 0;">Create Meal Plan</h2>
        <button type="button" class="modal-close" onclick="closeModal('plan-modal')">‚úï</button>
      </div>
      <form id="plan-form" style="display: grid; gap: 1.5rem;">
        <div class="form-group">
          <label for="plan-name">Plan Name</label>
          <input type="text" id="plan-name" required placeholder="e.g., High Protein Diet">
        </div>
        <div class="form-group">
          <label for="plan-description">Description</label>
          <textarea id="plan-description" placeholder="Describe your meal plan..."></textarea>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
          <div class="form-group">
            <label for="plan-calories">Daily Calories</label>
            <input type="number" id="plan-calories" placeholder="2000">
          </div>
          <div class="form-group">
            <label for="plan-protein">Protein (g)</label>
            <input type="number" id="plan-protein" placeholder="150">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
          <div class="form-group">
            <label for="plan-carbs">Carbs (g)</label>
            <input type="number" id="plan-carbs" placeholder="200">
          </div>
          <div class="form-group">
            <label for="plan-fat">Fat (g)</label>
            <input type="number" id="plan-fat" placeholder="65">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <button type="button" class="btn btn-outline" onclick="closeModal('plan-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Plan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Post Modal -->
  <div id="post-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="margin: 0;">Create Post</h2>
        <button type="button" class="modal-close" onclick="closeModal('post-modal')">‚úï</button>
      </div>
      <form id="post-form" style="display: grid; gap: 1.5rem;">
        <div class="form-group">
          <label for="post-title">Title</label>
          <input type="text" id="post-title" required placeholder="Share your achievement...">
        </div>
        <div class="form-group">
          <label for="post-content">Content</label>
          <textarea id="post-content" required placeholder="Tell your story..."></textarea>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <button type="button" class="btn btn-outline" onclick="closeModal('post-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Post</button>
        </div>
      </form>
    </div>
  </div>

  <script src="../script.js"></script>
  <script>
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
      initializeDashboard();
      loadSection('dashboard');
    });

    async function initializeDashboard() {
      const token = localStorage.getItem('token');
      const username = localStorage.getItem('username');

      if (!token) {
        window.location.href = '/login';
        return;
      }

      // Set greeting
      const hour = new Date().getHours();
      const greeting = hour < 12 ? 'Good morning' : hour < 18 ? 'Good afternoon' : 'Good evening';
      document.getElementById('greeting').textContent = `${greeting}, ${username}!`;

      // Load initial data
      loadUserProfile();
      loadDashboardData();
      setupEventListeners();
    }

    async function loadUserProfile() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/users/profile', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();

        if (response.ok) {
          const user = data.user;
          document.getElementById('profile-firstName').value = user.first_name || '';
          document.getElementById('profile-lastName').value = user.last_name || '';
          document.getElementById('profile-bio').value = user.bio || '';
          document.getElementById('profile-age').value = user.age || '';
          document.getElementById('profile-gender').value = user.gender || '';

          if (data.subscription) {
            document.getElementById('sub-status').textContent = data.subscription.plan_type.toUpperCase();
          }
        }
      } catch (error) {
        console.error('Error loading profile:', error);
      }
    }

    async function loadDashboardData() {
      try {
        const token = localStorage.getItem('token');

        // Load workouts
        const workoutRes = await fetch('/api/workouts?limit=7', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const workoutData = await workoutRes.json();
        
        // Load meals
        const mealsRes = await fetch('/api/meals/plans', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const mealsData = await mealsRes.json();

        // Load progress
        const progressRes = await fetch('/api/progress/summary/trends', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const progressData = await progressRes.json();

        // Update dashboard stats
        document.getElementById('workout-count').textContent = workoutData.total;
        document.getElementById('meal-count').textContent = workoutData.workouts.length;
        
        if (progressData.latest && progressData.latest.weight) {
          document.getElementById('current-weight').textContent = progressData.latest.weight + ' lbs';
        }

        // Create charts
        createCharts(workoutData.workouts, progressData.weightTrend);
        loadWorkoutsList(workoutData.workouts);
        loadMealPlans(mealsData.plans);
        loadProgressData(progressData);
      } catch (error) {
        console.error('Error loading dashboard data:', error);
      }
    }

    function createCharts(workouts, weightTrend) {
      // Workout chart
      const workoutCtx = document.getElementById('workout-chart');
      if (workoutCtx) {
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        new Chart(workoutCtx, {
          type: 'bar',
          data: {
            labels: days,
            datasets: [{
              label: 'Workouts',
              data: [3, 2, 4, 1, 3, 2, 1],
              backgroundColor: '#4f46e5',
              borderRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, max: 5 }
            }
          }
        });
      }

      // Weight chart
      const weightCtx = document.getElementById('weight-chart');
      if (weightCtx && weightTrend && weightTrend.length > 0) {
        const dates = weightTrend.map(w => new Date(w.date_recorded).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        const weights = weightTrend.map(w => w.weight);
        
        new Chart(weightCtx, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [{
              label: 'Weight (lbs)',
              data: weights,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true } },
            scales: {
              y: { title: { display: true, text: 'Weight (lbs)' } }
            }
          }
        });
      }
    }

    function loadWorkoutsList(workouts) {
      const tbody = document.getElementById('workouts-table');
      if (workouts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #6b7280;">No workouts logged yet</td></tr>';
        return;
      }

      tbody.innerHTML = workouts.map(w => `
        <tr>
          <td><strong>${w.exercise_name}</strong></td>
          <td>${w.muscle_group || '-'}</td>
          <td>${w.sets || '-'} x ${w.reps || '-'}</td>
          <td>${w.weight ? w.weight + ' lbs' : '-'}</td>
          <td>${w.duration ? w.duration + ' min' : '-'}</td>
          <td>${new Date(w.date_logged).toLocaleDateString()}</td>
          <td><button class="btn btn-small btn-outline" onclick="deleteWorkout(${w.id})">Delete</button></td>
        </tr>
      `).join('');
    }

    function loadMealPlans(plans) {
      const container = document.getElementById('meal-plans');
      if (plans.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center;">No meal plans created yet</p>';
        return;
      }

      container.innerHTML = plans.map(plan => `
        <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem; margin-bottom: 1rem;">
          <h4 style="margin: 0 0 0.5rem 0;">${plan.name}</h4>
          <p style="font-size: 0.875rem; color: #6b7280; margin: 0;">${plan.description || 'No description'}</p>
        </div>
      `).join('');
    }

    function loadProgressData(data) {
      const container = document.getElementById('measurements');
      if (data.latest) {
        const latest = data.latest;
        container.innerHTML = `
          <div style="display: grid; gap: 0.75rem;">
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
              <span>Weight</span>
              <strong>${latest.weight || 'N/A'} lbs</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
              <span>Body Fat</span>
              <strong>${latest.body_fat_percentage || 'N/A'}%</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
              <span>Chest</span>
              <strong>${latest.chest || 'N/A'} in</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
              <span>Waist</span>
              <strong>${latest.waist || 'N/A'} in</strong>
            </div>
          </div>
        `;
      }
    }

    function setupEventListeners() {
      document.getElementById('workout-form').addEventListener('submit', submitWorkout);
      document.getElementById('meal-form').addEventListener('submit', submitMeal);
      document.getElementById('progress-form').addEventListener('submit', submitProgress);
      document.getElementById('plan-form').addEventListener('submit', submitMealPlan);
      document.getElementById('post-form').addEventListener('submit', submitPost);
      document.getElementById('profile-form').addEventListener('submit', saveProfile);
    }

    async function submitWorkout(e) {
      e.preventDefault();
      const token = localStorage.getItem('token');

      const workoutData = {
        exercise_name: document.getElementById('exercise-name').value,
        muscle_group: document.getElementById('muscle-group').value,
        sets: parseInt(document.getElementById('workout-sets').value) || null,
        reps: parseInt(document.getElementById('workout-reps').value) || null,
        weight: parseFloat(document.getElementById('workout-weight').value) || null,
        duration: parseInt(document.getElementById('workout-duration').value) || null,
        notes: document.getElementById('workout-notes').value
      };

      try {
        const response = await fetch('/api/workouts', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(workoutData)
        });

        if (response.ok) {
          alert('Workout logged successfully!');
          closeModal('workout-modal');
          loadDashboardData();
          document.getElementById('workout-form').reset();
        }
      } catch (error) {
        console.error('Error logging workout:', error);
      }
    }

    async function submitMeal(e) {
      e.preventDefault();
      const token = localStorage.getItem('token');

      const mealData = {
        meal_type: document.getElementById('meal-type').value,
        food_name: document.getElementById('food-name').value,
        quantity: parseFloat(document.getElementById('food-quantity').value),
        unit: document.getElementById('food-unit').value,
        calories: parseInt(document.getElementById('food-calories').value) || 0,
        protein: parseFloat(document.getElementById('food-protein').value) || 0,
        carbs: parseFloat(document.getElementById('food-carbs').value) || 0,
        fat: parseFloat(document.getElementById('food-fat').value) || 0
      };

      try {
        const response = await fetch('/api/meals', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(mealData)
        });

        if (response.ok) {
          alert('Meal logged successfully!');
          closeModal('meal-modal');
          loadDashboardData();
          document.getElementById('meal-form').reset();
        }
      } catch (error) {
        console.error('Error logging meal:', error);
      }
    }

    async function submitProgress(e) {
      e.preventDefault();
      const token = localStorage.getItem('token');

      const progressData = {
        weight: parseFloat(document.getElementById('progress-weight').value) || null,
        body_fat_percentage: parseFloat(document.getElementById('progress-bodyfat').value) || null,
        chest: parseFloat(document.getElementById('progress-chest').value) || null,
        waist: parseFloat(document.getElementById('progress-waist').value) || null,
        hips: parseFloat(document.getElementById('progress-hips').value) || null,
        arms: parseFloat(document.getElementById('progress-arms').value) || null,
        thighs: parseFloat(document.getElementById('progress-thighs').value) || null,
        notes: document.getElementById('progress-notes').value
      };

      try {
        const response = await fetch('/api/progress', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(progressData)
        });

        if (response.ok) {
          alert('Progress recorded successfully!');
          closeModal('progress-modal');
          loadDashboardData();
          document.getElementById('progress-form').reset();
        }
      } catch (error) {
        console.error('Error recording progress:', error);
      }
    }

    async function submitMealPlan(e) {
      e.preventDefault();
      const token = localStorage.getItem('token');

      const planData = {
        name: document.getElementById('plan-name').value,
        description: document.getElementById('plan-description').value,
        calories_target: parseInt(document.getElementById('plan-calories').value),
        protein_target: parseInt(document.getElementById('plan-protein').value),
        carbs_target: parseInt(document.getElementById('plan-carbs').value),
        fat_target: parseInt(document.getElementById('plan-fat').value)
      };

      try {
        const response = await fetch('/api/meals/plans', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(planData)
        });

        if (response.ok) {
          alert('Meal plan created successfully!');
          closeModal('plan-modal');
          loadDashboardData();
          document.getElementById('plan-form').reset();
        }
      } catch (error) {
        console.error('Error creating meal plan:', error);
      }
    }

    async function submitPost(e) {
      e.preventDefault();
      const token = localStorage.getItem('token');

      const postData = {
        title: document.getElementById('post-title').value,
        content: document.getElementById('post-content').value
      };

      try {
        const response = await fetch('/api/community', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(postData)
        });

        if (response.ok) {
          alert('Post created successfully!');
          closeModal('post-modal');
          loadCommunityFeed();
          document.getElementById('post-form').reset();
        }
      } catch (error) {
        console.error('Error creating post:', error);
      }
    }

    async function saveProfile(e) {
      e.preventDefault();
      const token = localStorage.getItem('token');

      const profileData = {
        first_name: document.getElementById('profile-firstName').value,
        last_name: document.getElementById('profile-lastName').value,
        bio: document.getElementById('profile-bio').value,
        age: parseInt(document.getElementById('profile-age').value) || null,
        gender: document.getElementById('profile-gender').value || null
      };

      try {
        const response = await fetch('/api/users/profile', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(profileData)
        });

        if (response.ok) {
          alert('Profile updated successfully!');
        }
      } catch (error) {
        console.error('Error updating profile:', error);
      }
    }

    async function loadCommunityFeed() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/community', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();

        const feed = document.getElementById('community-feed');
        if (data.posts.length === 0) {
          feed.innerHTML = '<p style="text-align: center; color: #6b7280;">No posts yet. Be the first to share!</p>';
          return;
        }

        feed.innerHTML = data.posts.map(post => `
          <div class="card">
            <div style="display: flex; gap: 1rem;">
              <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div>
                    <h3 style="margin: 0 0 0.5rem 0;">${post.title}</h3>
                    <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">by ${post.username}</p>
                  </div>
                  <span class="badge badge-primary">${new Date(post.created_at).toLocaleDateString()}</span>
                </div>
                <p style="margin: 1rem 0 0 0;">${post.content}</p>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                  <button class="btn btn-small btn-outline" onclick="likePost(${post.id})">‚ù§Ô∏è ${post.likes || 0}</button>
                  <button class="btn btn-small btn-outline" onclick="loadComments(${post.id})">üí¨ ${post.comment_count || 0}</button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading community feed:', error);
      }
    }

    async function loadTrainers() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/users/trainers', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();

        const container = document.getElementById('trainers-list');
        if (data.trainers.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #6b7280;">No trainers available</p>';
          return;
        }

        container.innerHTML = data.trainers.map(trainer => `
          <div class="card">
            <h3 style="margin: 0 0 0.5rem 0;">${trainer.first_name} ${trainer.last_name}</h3>
            <p style="margin: 0.5rem 0; color: #6b7280; font-size: 0.875rem;">@${trainer.username}</p>
            <p style="margin: 1rem 0;">${trainer.bio || 'No bio provided'}</p>
            <button class="btn btn-secondary" style="width: 100%;" onclick="assignTrainer(${trainer.id})">Request Trainer</button>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading trainers:', error);
      }
    }

    async function assignTrainer(trainerId) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/users/assign-trainer/${trainerId}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();

        if (response.ok) {
          alert('Trainer assigned successfully!');
        } else {
          alert(data.message);
        }
      } catch (error) {
        console.error('Error assigning trainer:', error);
      }
    }

    async function loadSubscriptionInfo() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/subscriptions', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();

        const container = document.getElementById('subscription-info');
        const sub = data.subscription;

        if (!sub) {
          container.innerHTML = '<p>No active subscription. Start with our free plan!</p>';
          return;
        }

        container.innerHTML = `
          <div style="padding: 1.5rem;">
            <div style="margin-bottom: 1.5rem;">
              <p><strong>Current Plan:</strong> ${sub.plan_type.toUpperCase()}</p>
              <p><strong>Status:</strong> <span class="badge badge-success">${sub.status.toUpperCase()}</span></p>
              <p><strong>Price:</strong> $${sub.price_per_month || 'Free'}/month</p>
            </div>
            ${sub.status === 'active' ? `
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <button class="btn btn-primary" onclick="upgradePlan()">Upgrade Plan</button>
                <button class="btn btn-outline" onclick="cancelSubscription()">Cancel</button>
              </div>
            ` : ''}
          </div>
        `;
      } catch (error) {
        console.error('Error loading subscription:', error);
      }
    }

    function loadSection(section) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));

      // Remove active class from all menu items
      document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));

      // Show selected section
      const sectionId = section + '-section';
      const sectionElement = document.getElementById(sectionId);
      if (sectionElement) {
        sectionElement.classList.remove('hidden');

        // Add active class to menu item
        document.querySelector(`a[onclick*="${section}"]`)?.classList.add('active');

        // Load section-specific data
        if (section === 'trainers') loadTrainers();
        if (section === 'community') loadCommunityFeed();
        if (section === 'subscription') loadSubscriptionInfo();
      }
    }

    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    async function deleteWorkout(id) {
      if (!confirm('Delete this workout?')) return;

      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/workouts/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          loadDashboardData();
        }
      } catch (error) {
        console.error('Error deleting workout:', error);
      }
    }

    async function likePost(id) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/community/${id}/like`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          loadCommunityFeed();
        }
      } catch (error) {
        console.error('Error liking post:', error);
      }
    }

    function viewDailyMeals() {
      const date = new Date().toISOString().split('T')[0];
      // Navigate to meals section and load specific date
      loadSection('nutrition');
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('userId');
        localStorage.removeItem('userRole');
        localStorage.removeItem('username');
        window.location.href = '/';
      }
    }
  </script>
</body>
</html>
